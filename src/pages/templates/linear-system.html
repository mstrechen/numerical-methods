{% extends "basic-template.html" %}
{% block title %} Linear system {% endblock %} 


{% block content %}
<div class="container mt-4">
    <p>
        We will take a look at two methods of linear system solving: Gaussian elimination and Jacobi method.  
    </p>
    <p>
        You can set the size <strong>N</strong> of the matrix which will be generated by the following rule:<br>
        $
            \begin{pmatrix} 
            1 & 2 & 3 & \dots & n-1 & n \\
            -1 & 0 & 3 & \dots & n-1 & n \\
            -1 & -2 & 0 & \dots & n-1 & n \\
             & \vdots &  & \ddots &  &  \\
            -1 & -2 & -3 & \dots & -n+1 & 0 \\ 
            \end{pmatrix}
            = 
            \begin{pmatrix} 
            1 \\
            2 \\
            3 \\
            \vdots \\
            n \\

            \end{pmatrix}
        $ 
    </p>
    <p>Note that N should belong to $[10, 100]$.</p>
    <p>
        Have fun!
    </p>

    <div class="container rounded border calc-card">
        <div class="row border rounded">
                <div id="results-jacobi" class="col-md-4 text-center bg-light rounded-left"
                style="min-height: 110px">
                </div>
                <div class="col-md-4 pt-1 text-center bg-dark rounded">
                    <form class="mt-2 text-white px-3">
                        <div class="row">
                            <label for="n" class="col-md-2 mt-2 col-md-smallpad">N =</label>
                            <input type="text" class="form-control col-md-10" id="n" placeholder="f(x)" value="10">
                        </div>
                        <div class="row mt-1">
                            <div class="col-md-12 ">
                                <button type="button" onclick="solve()" class="btn btn-primary mb-2" style="width:100%">Calculate</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div id="results-gauss" class="col-md-4 text-center bg-light rounded-right"
                style="min-height: 110px">
                </div>
        </div>
    </div>
    <script type="text/javascript" language="JavaScript">
        function get_form_data(){
            var data = {}
            data.n = document.getElementById("n").value
            return data;
        }
        function tex_format_number(s){
            if(s === undefined)
                return s;
            console.log("@#", s)
            s = String(s)
            if(s.indexOf('e') == -1)
                return s;
            f_p = s.slice(0, s.indexOf('e'))
            l_p = s.slice(s.indexOf('e') + 1)
            return `${Math.round(f_p * 100000) / 100000} \\times 10^{${l_p}}` 
        }
        function save_result(res_div_id){
            data = window.localStorage.getItem(`SAVEDRES-${res_div_id}`)
            var blob = new Blob([data],
            { type: "text/plain;charset=utf-8" });
            saveAs(blob, "results.txt");
        }
        function put_answer(endpoint, res_div_id){

            var Http = new XMLHttpRequest()
            var url = endpoint

            Http.open("GET", url);
            Http.onreadystatechange = (e) => {
                res = JSON.parse(Http.responseText || "{}")
                if(res.error_occured){
                    document.getElementById(res_div_id).innerText = res.error_occured
                } else {
                    tosave = ""
                    res.ans.forEach((x) => tosave += String(x) + " ")
                    var blob = new Blob([tosave], { type: "text/plain;charset=utf-8" });

                    var error = tex_format_number(res.error);
                    document.getElementById(res_div_id).innerHTML = 
                    '<p>'
                    + `$|Ax - b| = ${error}$`
                    + '</p>'
                    +`<a class="btn btn-secondary" download='result.txt' href=${URL.createObjectURL(blob)}>Save the solution!</a>`
                    ;
                    MathJax.Hub.Queue(["Typeset", MathJax.Hub, res_div_id]);
                    
                    window.localStorage.setItem(`SAVEDRES-${res_div_id}`, tosave)
                }
            }
            Http.send();
        }
        function solve(){
            data = get_form_data()
            endpoint_gauss = `/api/linear-systems/gaussian?n=${data.n}`
            endpoint_jacobi = `/api/linear-systems/jacobi?n=${data.n}`
            put_answer(endpoint_jacobi, 'results-jacobi')
            put_answer(endpoint_gauss, 'results-gauss')
            MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
        }

        solve()
    </script>
</div>
{% endblock %}